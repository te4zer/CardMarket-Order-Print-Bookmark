javascript:(function(){try{const languageNameMap={'1':'Englisch','2':'Französisch','3':'Deutsch','4':'Spanisch','5':'Italienisch','6':'S-Chinesisch','7':'Japanisch','8':'Portugiesisch','9':'Russisch','10':'Koreanisch','11':'T-Chinesisch','12':'Ungarisch'};const conditionMap={'1':'Mint','2':'Near Mint','3':'Excellent','4':'Good','5':'Light Played','6':'Played','7':'Poor'};const scryfallLangMap={'1':'en','2':'fr','3':'de','4':'es','5':'it','6':'zh','7':'ja','8':'pt','9':'ru','10':'ko','11':'zh','12':'hu'};const delay=ms=>new Promise(resolve=>setTimeout(resolve,ms));function showLoadingOverlay(current,total){const id='mkm-loader-overlay';let overlay=document.getElementById(id);const message=`LADE DATEN... ${current}/${total}`;if(!overlay){overlay=document.createElement('div');overlay.id=id;overlay.style.cssText=`position: fixed;top: 20px;right: 20px;padding: 10px 15px;background-color: #ffc107;color: #343a40;font-weight: bold;font-family: sans-serif;border-radius: 5px;box-shadow: 0 4px 8px rgba(0,0,0,0.2);z-index: 10000;`;document.body.appendChild(overlay);}overlay.textContent=message;if(current>=total&&total>0){setTimeout(()=>{if(document.getElementById(id)){document.getElementById(id).remove();}},500);}}function extractHeaderData(){const orderHeader=document.querySelector('div.page-title-container h1');const orderNumber=orderHeader?orderHeader.textContent.match(/#(\d+)/)?.[1]||'UNBEKANNT':'UNBEKANNT';const addressBlock=document.querySelector('.shipment-detail-collapse .text-break');let addressLines=[];let recipientName='Name Nicht Gefunden';if(addressBlock){const name=addressBlock.querySelector('.Name')?.textContent||'';const street=addressBlock.querySelector('.Street')?.textContent||'';const city=addressBlock.querySelector('.City')?.textContent||'';const country=addressBlock.querySelector('.Country')?.textContent||'';recipientName=name;addressLines=[name,street,city,country].filter(line=>line);}const address=addressLines.join('\n');return{orderNumber,recipientName,address};}function extractTableData(){const rows=document.querySelectorAll('tr[data-product-id]');const artikelListe=[];rows.forEach(row=>{const englishNameElement=row.querySelector('.name.text-start div.small.text-muted.fst-italic');const englishName=englishNameElement?englishNameElement.textContent.trim():null;const expansionName=row.getAttribute('data-expansion-name');if(!englishName)return;const raritySpan=row.querySelector('.rarity-symbol');const rarity=raritySpan?raritySpan.getAttribute('aria-label'):'Unbekannt (HTML-Struktur fehlt)';const langCode=row.getAttribute('data-language');const conditionCode=row.getAttribute('data-condition');const extrasCell=row.querySelector('.col-extras');const isFoil=extrasCell?!!extrasCell.querySelector('.extras .icon[aria-label="Foil"]'):false;artikelListe.push({query_name:englishName,language:languageNameMap[langCode]||`Code ${langCode}`,rarity:rarity,is_foil:isFoil?'Ja':'Nein',condition:conditionMap[conditionCode]||`Code ${conditionCode}`,set_name:expansionName,language_code:langCode,final_name:null,mana_cost:null,colors:null,});});const uniqueMap=new Map();artikelListe.forEach(item=>uniqueMap.set(item.query_name+item.set_name+item.language_code,item));return Array.from(uniqueMap.values());}async function getCardDetails(item){const scryfallCode=scryfallLangMap[item.language_code]||'en';let cleanQueryName = item.query_name.replace(/\s*\([^)]+\)$/, '');if (item.rarity === 'Basic Land') {item.final_name = item.query_name;item.mana_cost = 'Land';item.colors = 'N/A';return item;}const url=`https://api.scryfall.com/cards/search?q=!%22${encodeURIComponent(cleanQueryName)}%22+lang%3A${scryfallCode}`;try{const response=await fetch(url);if(!response.ok||response.status===404){item.final_name='(Siehe Bild/Token)';item.mana_cost='N/A';item.colors='N/A';return item;}const json=await response.json();const data=json.data?.[0];if(!data){item.final_name='(Siehe Bild/Token)';item.mana_cost='N/A';item.colors='N/A';return item;}item.final_name=data.printed_name||data.card_faces?.[0]?.printed_name||data.name;if(data.mana_cost===""){item.mana_cost='Land';}else if(data.mana_cost==="{0}"){item.mana_cost='{0}';}else{item.mana_cost=data.mana_cost||'Keine Angabe';}item.colors=data.colors?.join(', ')||'Farblos';return item;}catch(error){item.final_name='(Siehe Bild/Token)';item.mana_cost='N/A';item.colors='N/A';return item;}}function getColorSortingKey(colorsString){if(colorsString==='Farblos')return[0,'Colorless'];if(colorsString==='N/A'||colorsString==='Keine Angabe')return[100,'ZZZ_Unknown'];const colorsArray=colorsString.split(', ').sort();const count=colorsArray.length;const sortedColorString=colorsArray.join(', ');return[count,sortedColorString];}function getCmcValue(manaCost){if(manaCost==='N/A')return 999;if(manaCost==='Land')return -100;if(manaCost==='{0}')return 0;const match=manaCost.match(/\{(\d+)\}/);return match?parseInt(match[1],10):99;}function sortResults(results){const rarityOrder=['Mythic','Mythic Rare','Rare','Special','Uncommon','Common','Basic Land','Unbekannt'];const getRarityIndex=(rarity)=>rarityOrder.indexOf(rarity)!==-1?rarityOrder.indexOf(rarity):99;results.sort((a,b)=>{const rarityDiff=getRarityIndex(a.rarity)-getRarityIndex(b.rarity);if(rarityDiff!==0)return rarityDiff;const langDiff=a.language.localeCompare(b.language);if(langDiff!==0)return langDiff;const[countA,keyA]=getColorSortingKey(a.colors);const[countB,keyB]=getColorSortingKey(b.colors);if(countA!==countB)return countA-countB;const colorKeyDiff=keyA.localeCompare(keyB);if(colorKeyDiff!==0)return colorKeyDiff;const cmcDiff=getCmcValue(a.mana_cost)-getCmcValue(b.mana_cost);if(cmcDiff!==0)return cmcDiff;const nameDiff=a.final_name.localeCompare(b.final_name);if(nameDiff!==0)return nameDiff;const conditionDiff=a.condition.localeCompare(b.condition);return conditionDiff;});return results;}function printTable(results,headerData){const{orderNumber,recipientName,address}=headerData;const columnHeaders=['Sprache','Rarity','Farbe','Foil','Zustand','Übersetzter Name','Set Name','Mana','Englischer Name'];const COL_COUNT=columnHeaders.length;const formattedAddress=address.replace(/\n/g,'<br>');const loader=document.getElementById('mkm-loader-overlay');if(loader){loader.remove();}let tableHTML=`<html><head><title>Cardmarket Bestellübersicht #${orderNumber}</title><style>body{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}body{font-family:sans-serif;margin:10px;}h1{font-size:16pt;margin-bottom:0px;}.recipient-name{font-size:12pt;margin-bottom:15px;}table{width:100%;border-collapse:collapse;font-size:9pt;margin-top:15px;}th,td{border:1px solid #ccc;padding:3px 5px;text-align:left;vertical-align:top;}th{background-color:#f8f8f8;font-weight:bold;}.address-label-box{border:2px dashed #000;padding:10px;width:45%;float:right;margin-left:20px;margin-top:10px;}.address-content{font-family:monospace,sans-serif;font-size:11pt;line-height:1.4;white-space:pre-wrap;}.clear-fix{clear:both;}.rarity-separator td{border:1px solid #000!important;border-left:none!important;border-right:none!important;height:15px;background-color:#ddd;font-weight:bold;text-align:left;}.mono-color-separator td,.color-count-separator td{border:none!important;height:5px;background-color:#f0f0f0;}@media print{@page{size:A4 portrait;margin:10mm;}body{font-size:8pt;margin:0;}h1{font-size:14pt;margin-bottom:2px;}.recipient-name{font-size:10pt;margin-bottom:8px;}table{width:100%;table-layout:fixed;margin-top:10px;}th,td{border:1px solid #000;padding:2px 4px;word-wrap:break-word;white-space:normal;}th:nth-child(1),td:nth-child(1){width:8%;}th:nth-child(2),td:nth-child(2){width:8%;}th:nth-child(3),td:nth-child(3){width:8%;}th:nth-child(4),td:nth-child(4){width:4%;}th:nth-child(5),td:nth-child(5){width:8%;}th:nth-child(6),td:nth-child(6){width:22%;}th:nth-child(7),td:nth-child(7){width:15%;}th:nth-child(8),td:nth-child(8){width:7%;}th:nth-child(9),td:nth-child(9){width:20%;}.rarity-separator td{border-top:2px solid #000!important;border-bottom:2px solid #000!important;border-left:none!important;border-right:none!important;background-color:#ddd;color:#000;font-weight:bold;font-size:8pt;line-height:1;}.address-label-box{border:2px dashed #000;padding:8px;width:48%;float:right;margin-left:15px;margin-top:0;}.address-content{font-size:10pt;line-height:1.3;}}</style></head><body><div class="address-label-box"><div class="address-content">${formattedAddress}</div></div><h1>Bestellung #${orderNumber}</h1><p class="recipient-name">${recipientName}</p><div class="clear-fix"></div><table><thead><tr>${columnHeaders.map(header=>`<th>${header}</th>`).join('')}</tr></thead><tbody>`;let prevRarity=null;let prevLanguage=null;let prevColors=null;results.forEach(item=>{const currentRarity=item.rarity;const currentLanguage=item.language;const[colorCount,colorKey]=getColorSortingKey(item.colors);const currentCmc=getCmcValue(item.mana_cost);if(!prevRarity||currentRarity!==prevRarity){tableHTML+=`<tr class="rarity-separator"><td>${currentRarity.toUpperCase()}</td><td colspan="${COL_COUNT-1}"></td></tr>`;}if(currentRarity===prevRarity){const[prevColorCount,prevColorKey]=getColorSortingKey(prevColors);if (item.mana_cost !== 'Land' && item.mana_cost !== 'N/A' && prevColors !== 'N/A' && prevColors !== 'Keine Angabe' && prevColors !== 'Farblos'){if (currentLanguage!==prevLanguage){tableHTML+=`<tr class="color-count-separator"><td colspan="${COL_COUNT}"></td></tr>`;} else if (colorKey!==prevColorKey){tableHTML+=`<tr class="mono-color-separator"><td colspan="${COL_COUNT}"></td></tr>`;}} else if (colorCount !== prevColorCount || currentLanguage!==prevLanguage) {tableHTML+=`<tr class="color-count-separator"><td colspan="${COL_COUNT}"></td></tr>`;}}const rowData=[currentLanguage,currentRarity,item.colors,item.is_foil,item.condition,item.final_name,item.set_name,item.mana_cost,item.query_name,];tableHTML+=`<tr>${rowData.map(data=>`<td>${data}</td>`).join('')}</tr>`;prevRarity=currentRarity;prevLanguage=currentLanguage;prevColors=item.colors;});tableHTML+=`</tbody></table></body></html>`;const printWindow=window.open('','PrintTable','height=600,width=900');if(printWindow){printWindow.document.write(tableHTML);printWindow.document.close();printWindow.onload=function(){printWindow.focus();printWindow.print();};}else{console.error("Popup blockiert! Bitte Popups für diese Seite zulassen und erneut versuchen.");}}async function fetchAllCardDetails(){const headerData=extractHeaderData();let artikelListe=extractTableData();const totalItems=artikelListe.length;showLoadingOverlay(0,totalItems);console.log(`✅ Bestellnummer: ${headerData.orderNumber}`);console.log(`✅ ${totalItems} eindeutige Artikel zur Abfrage gefunden. Starte API-Abrufe...`);const ergebnisse=[];for(const[index,item]of artikelListe.entries()){const current=index+1;showLoadingOverlay(current,totalItems);const details=await getCardDetails(item);ergebnisse.push(details);await delay(100);}const sortedErgebnisse=sortResults(ergebnisse);console.log('\n--- ✅ ALLE DATEN ABGERUFEN, SORTIERT UND DRUCK VORBEREITET ---');printTable(sortedErgebnisse,headerData);}fetchAllCardDetails();}catch(e){console.error("Fehler bei der Ausführung des Bookmarklets:", e);alert("Fehler beim Ausführen des Skripts. Details finden Sie in der Browser-Konsole (F12).");}})();
